# 手机号注册登录改造完成

## 改动概述

已将系统从**邮箱+密码**注册登录改为**手机号+密码**注册登录。

## 后端改动

### 1. 实体层 (Entity)
- **User.java**: 
  - `phone` 字段改为必填且唯一 (`@NotBlank`, `@Column(unique=true, nullable=false)`)
  - `email` 字段改为可选 (`@Email`, 无 `@NotBlank`)

### 2. DTO层
- **AuthDtos.java**:
  - `RegisterRequest`: 使用 `phone` 替代 `email` (11位手机号验证)
  - `LoginRequest`: 使用 `phone` 替代 `username` (手机号登录)
  - `AuthResponse`: 返回 `phone` 替代 `email`
- **UserDtos.java**:
  - `UpdateProfileRequest`: `phone` 改为11位验证,`email` 标记为可选

### 3. Repository层
- **UserRepository.java**:
  - 添加 `findByPhone(String phone)` 方法
  - 添加 `existsByPhone(String phone)` 方法

### 4. Service层
- **AuthService.java**:
  - `register()`: 检查手机号唯一性,使用手机号注册
  - `login()`: 通过手机号查找用户,验证密码
- **UserService.java**:
  - `updateUserProfile()`: 添加手机号唯一性检查

### 5. API文档
- **API文档.md**: 更新所有认证和用户相关接口的说明

## 前端改动

### 1. 注册表单 (RegisterForm.vue)
- 使用手机号输入框替代邮箱
- 添加手机号格式验证 (11位,1开头)
- 更新提交数据结构

### 2. 登录表单 (LoginForm.vue)
- 使用手机号输入框替代用户名
- 添加手机号格式验证
- 更新提交数据结构

### 3. 个人信息页面 (Profile.vue)
- 手机号字段设为只读 (注册后不可修改)
- 邮箱字段改为可选
- 调整字段顺序

## 数据验证规则

### 注册
- ✅ 用户名: 3-50个字符,必填,唯一
- ✅ 手机号: 11位,必填,唯一,格式验证
- ✅ 密码: 6-100个字符,必填
- ✅ 昵称: 可选,默认为用户名

### 登录
- ✅ 手机号: 11位,必填
- ✅ 密码: 6个字符以上,必填

### 个人信息更新
- ✅ 昵称: 可选
- ✅ 手机号: 不可修改
- ✅ 邮箱: 可选,可修改(检查唯一性)
- ✅ 头像: 可选,支持Base64

## 测试

运行测试脚本:
```powershell
cd backend
./test-phone-auth.ps1
```

## API变更示例

### 注册接口
**之前:**
```json
{
  "username": "zhangsan",
  "email": "zhangsan@example.com",
  "password": "password123"
}
```

**现在:**
```json
{
  "username": "zhangsan",
  "phone": "13800138000",
  "password": "password123"
}
```

### 登录接口
**之前:**
```json
{
  "username": "zhangsan",
  "password": "password123"
}
```

**现在:**
```json
{
  "phone": "13800138000",
  "password": "password123"
}
```

## 数据库变更

需要更新现有数据库:
1. `phone` 字段改为 `NOT NULL` 和 `UNIQUE`
2. `email` 字段改为可空

如使用H2内存数据库,重启后会自动应用新schema。

## 注意事项

⚠️ **重要提醒:**
- 现有用户数据需要迁移(确保所有用户都有有效手机号)
- 手机号注册后不可修改
- 邮箱现在是可选字段,可以为空
- JWT Token中包含 `phone` 而非 `email`

## 兼容性

- ✅ 后端完全兼容
- ✅ 前端完全兼容
- ✅ API文档已更新
- ✅ 保持原有用户名字段不变(用于显示)
